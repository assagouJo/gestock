{% extends "base.html" %}
{% block title %}Nouvelle Vente{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="fw-bold text-primary mb-0">üìã Ventes</h4>
  <button class="btn btn-outline-primary"
          data-bs-toggle="modal"
          data-bs-target="#venteModal">
    ‚ûï Nouvelle Vente
  </button>
</div>

{% if ventes %}
<form action="{{ url_for('supprimer_ventes') }}" method="post">

  <div class="table-responsive" style="max-height: 380px; overflow-y: auto;">
    <table class="table table-hover table-bordered align-middle">
      <thead class="table-dark sticky-top">
        <tr>
          <th width="30"></th>
          <th>Date</th>
          <th>Client</th>
          <th>Produits</th>
          <th>Prix</th>
          <th>Qt√©</th>
          <th>Sous-total</th>
          <th>Statut</th>
          <th>Action</th>
          <th>Voir</th>
        </tr>
      </thead>

      <tbody>
      {% for vente in ventes %}
        <tr ondblclick="ouvrirEdition(this)"
            data-id="{{ vente.id }}"
            style="cursor:pointer">

          <!-- CHECKBOX -->
          <td class="text-center">
            <input type="checkbox" name="vente_ids" value="{{ vente.id }}">
          </td>

          <!-- DATE -->
          <td>{{ vente.date_vente.strftime('%d/%m/%Y') }}</td>

          <!-- CLIENT -->
          <td class="fw-bold text-primary">
            {{ vente.client.nom_client }}
          </td>

          <!-- PRODUITS -->
          <td class="cell-divided">
            {% for ligne in vente.lignes %}
              {% if ligne.stock and ligne.stock.produit %}
                <div>{{ ligne.stock.produit.nom_produit }}</div>
              {% else %}
                <div class="text-danger">Produit supprim√©</div>
              {% endif %}
            {% endfor %}
          </td>
          <!-- PRIX -->
          <td class="cell-divided">
            {% for ligne in vente.lignes %}
              <div>{{ (ligne.prix_unitaire) | money}}</div>
            {% endfor %}
          </td>

          <!-- QUANTIT√â -->
          <td class="cell-divided">
            {% for ligne in vente.lignes %}
              <div>{{ ligne.quantite }}</div>
            {% endfor %}
          </td>

          <!-- SOUS-TOTAL -->
          <td class="cell-divided">
            {% for ligne in vente.lignes %}
              <div>{{ (ligne.quantite * ligne.prix_unitaire) | money}}</div>
            {% endfor %}
          </td>
          <!-- STATUT -->
          <td>
            {% if vente.statut_paiement == "paye" %}
              <span class="badge bg-success">Pay√©e</span>
            {% elif vente.statut_paiement == "partiel" %}
              <span class="badge bg-warning text-dark">Partielle</span>
            {% else %}
              <span class="badge bg-danger">Impay√©e</span>
            {% endif %}
          </td>

          <!-- ACTION -->
          <td>
            <a href="{{ url_for('paiement_vente', vente_id=vente.id) }}"
               class="btn btn-sm btn-primary">
              üí∞ Paiement
            </a>
          </td>          
            <td>
              <a href="{{ url_for('voir_facture', vente_id=vente.id) }}"
                class="btn btn-sm btn-outline-secondary">
                üßæ Facture
              </a>
            </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <button type="submit"
          class="btn btn-outline-danger mt-3"
          onclick="return confirm('Voulez-vous supprimer les ventes s√©lectionn√©es ?')">
    üóëÔ∏è Supprimer
  </button>

</form>

{% else %}
<div class="alert alert-warning text-center">
  Aucune vente enregistr√©e.
</div>
{% endif %}

<!-- ================================================= -->
<!-- üßæ MODAL : NOUVELLE VENTE -->
<!-- ================================================= -->
<div class="modal fade" id="venteModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title fw-bold text-primary">
          üßæ Nouvelle Vente
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form method="post" action="{{ url_for('nouvelle_vente') }}">

          <!-- CLIENT -->
          <div class="row mb-3">
            <div class="col-md-4">
              <label class="form-label fw-bold">Client</label>
              <select name="client_id" class="form-select" required>
                {% for c in clients %}
                  <option value="{{ c.id }}">{{ c.nom_client }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- LIGNES -->
          <table class="table table-sm table-bordered">
            <thead class="table-light">
              <tr>
                <th>Produit</th>
                <th>Lot</th>
                <th width="120">Qt√©</th>
                <th width="150">Prix</th>
                <th width="40"></th>
              </tr>
            </thead>

            <tbody id="lignesVente">
              <tr class="ligne-vente">

                <!-- PRODUIT -->
                <td>
                  <select class="form-select produit-select" required>
                    <option value="">-- Produit --</option>
                    {% for p in produits %}
                      <option value="{{ p.id }}">{{ p.nom_produit }}</option>
                    {% endfor %}
                  </select>
                </td>

                <!-- LOT -->
                <td>
                  <select name="stock_id[]" class="form-select stock-select" required>
                    <option value="">-- Lot --</option>
                    {% for p in produits %}
                      {% for s in p.stocks %}
                        <option value="{{ s.id }}" data-produit="{{ p.id }}">
                          {{ s.numero_lot }} ({{ s.quantite }})
                        </option>
                      {% endfor %}
                    {% endfor %}
                  </select>
                </td>

                <!-- QTE -->
                <td>
                  <input type="number" name="quantite[]"
                         class="form-control" min="1" required>
                </td>

                <!-- PRIX -->
                <td>
                  <input type="number" name="prix_unitaire[]"
                         class="form-control" min="0" step="0.01" required>
                </td>

                <!-- ACTION -->
                <td class="text-center">
                  <button type="button"
                          class="btn btn-danger btn-sm supprimer">‚úñ</button>
                </td>

              </tr>
            </tbody>
          </table>

          <button type="button"
                  class="btn btn-outline-secondary mb-3"
                  id="ajouterLigneVente">
            ‚ûï Ajouter ligne
          </button>

          <div class="d-flex justify-content-end gap-2">
            <button type="submit" class="btn btn-primary">
              Valider
            </button>
            <button type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal">
              Annuler
            </button>
          </div>

        </form>
      </div>

    </div>
  </div>
</div>

<!-- ================================================= -->
<!-- üß† JS -->
<!-- ================================================= -->
<script>
function ouvrirEdition(row) {
  const id = row.dataset.id;
  if (id) {
    window.location.href = `/vente/${id}/edit`;
  }
}

document.addEventListener("DOMContentLoaded", () => {

  const tbody = document.getElementById("lignesVente");
  const btnAjouter = document.getElementById("ajouterLigneVente");

  btnAjouter.addEventListener("click", () => {
    const ligne = tbody.querySelector(".ligne-vente").cloneNode(true);
    ligne.querySelectorAll("input").forEach(i => i.value = "");
    ligne.querySelectorAll("select").forEach(s => s.selectedIndex = 0);
    tbody.appendChild(ligne);
  });

  tbody.addEventListener("click", e => {
    if (e.target.classList.contains("supprimer") && tbody.children.length > 1) {
      e.target.closest("tr").remove();
    }
  });

  document.addEventListener("change", e => {
    if (e.target.classList.contains("produit-select")) {
      const produitId = e.target.value;
      const ligne = e.target.closest("tr");
      const stockSelect = ligne.querySelector(".stock-select");

      stockSelect.value = "";
      stockSelect.querySelectorAll("option").forEach(opt => {
        if (!opt.dataset.produit) return;
        opt.style.display =
          opt.dataset.produit === produitId ? "block" : "none";
      });
    }
  });

});
</script>

{% endblock %}
