{% extends "base.html" %}
{% block title %}Nouvelle Vente{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="fw-bold text-primary mb-0">üìã Ventes</h4>
  <div>
    <button class="btn btn-outline-primary"
            data-bs-toggle="modal"
            data-bs-target="#venteModal">
      ‚ûï Nouvelle Vente
    </button>
        <a href="{{ url_for('nouvelle_proforma') }}"
         class="btn btn-info">
        ‚ûï Nouvelle proforma
      </a>
        <a href="{{ url_for('nouveau_bon_commande') }}"
         class="btn btn-info">
        ‚ûï Bon de Commande
      </a>
  </div>
</div>

{% if ventes %}
<form action="{{ url_for('supprimer_ventes') }}" method="post">

  <div class="table-responsive" style="max-height: 380px; overflow-y: auto;">
    <table class="table table-hover table-bordered align-middle">
      <thead class="table-dark sticky-top">
        <tr>
          <th width="30"></th>
          <th>Date</th>
          <th>Client</th>
          <th>Vendeur</th>
          <th>Compagnie</th>
          <th>Produits</th>
          <th>Prix</th>
          <th>Qt√©</th>
          <th>Sous-total</th>
          <th>Statut</th>
          <th>Action</th>
          <th>Voir</th>
        </tr>
      </thead>

      <tbody>
      {% for vente in ventes %}
        <tr ondblclick="ouvrirEdition(this)"
            data-id="{{ vente.id }}"
            style="cursor:pointer">

          <td class="text-center">
            <input type="checkbox" name="vente_ids" value="{{ vente.id }}">
          </td>

          <td>{{ vente.date_vente.strftime('%d/%m/%Y') }}</td>

          <td class="fw-bold text-primary">
            {{ vente.client.nom_client }}
          </td>

          <!-- üî• VENDEUR -->
          <td class="fw-bold text-dark">
            {{ vente.vendeur.nom }}
          </td>

          <!-- üî• COMPAGNIE -->
          <td>
            <span class="badge bg-info text-dark">
              {{ vente.compagnie.nom }}
            </span>
          </td>

          <!-- PRODUITS -->
          <td class="cell-divided">
            {% for ligne in vente.lignes %}
              {% if ligne.stock and ligne.stock.produit %}
                <div>{{ ligne.stock.produit.nom_produit }}</div>
              {% else %}
                <div class="text-danger">Produit supprim√©</div>
              {% endif %}
            {% endfor %}
          </td>

          <!-- PRIX -->
          <td class="cell-divided">
            {% for ligne in vente.lignes %}
              <div>{{ ligne.prix_unitaire | money }}</div>
            {% endfor %}
          </td>

          <!-- QT√â -->
          <td class="cell-divided">
            {% for ligne in vente.lignes %}
              <div>{{ ligne.quantite }}</div>
            {% endfor %}
          </td>

          <!-- SOUS-TOTAL -->
          <td class="cell-divided">
            {% for ligne in vente.lignes %}
              <div>{{ (ligne.quantite * ligne.prix_unitaire) | money }}</div>
            {% endfor %}
          </td>

          <!-- STATUT -->
          <td>
            {% if vente.statut_paiement == "paye" %}
              <span class="badge bg-success">Pay√©e</span>
            {% elif vente.statut_paiement == "partiel" %}
              <span class="badge bg-warning text-dark">Partielle</span>
            {% else %}
              <span class="badge bg-danger">Impay√©e</span>
            {% endif %}
          </td>

          <td>
            <a href="{{ url_for('paiement_vente', vente_id=vente.id) }}"
               class="btn btn-sm btn-primary">
              üí∞ Paiement
            </a>
          </td>

          <td>
            <a href="{{ url_for('voir_facture', vente_id=vente.id) }}"
               class="btn btn-sm btn-outline-secondary">
              üßæ Facture
            </a>
          </td>

        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <button type="submit"
          class="btn btn-outline-danger mt-3"
          onclick="return confirm('Voulez-vous supprimer les ventes s√©lectionn√©es ?')">
    üóëÔ∏è Supprimer
  </button>

</form>

{% else %}
<div class="alert alert-warning text-center">
  Aucune vente enregistr√©e.
</div>
{% endif %}

<!-- ================================================= -->
<!-- üßæ MODAL : NOUVELLE VENTE -->
<!-- ================================================= -->
<div class="modal fade" id="venteModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title fw-bold text-primary">
          üßæ Nouvelle Vente
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form method="post" action="{{ url_for('nouvelle_vente') }}">

          <!-- üî• CLIENT + VENDEUR + COMPAGNIE -->
          <div class="row mb-3">

             <div class="col-md-3">
              <label class="form-label fw-bold">Date</label>
              <input type="datetime-local"
                    name="date_vente"
                    class="form-control"
                    value="{{ now.strftime('%Y-%m-%d') }}"
                    required>
            </div>

            <div class="col-md-4">
              <label class="form-label fw-bold">Client</label>
              <select name="client_id" class="form-select" required>
                {% for c in clients %}
                  <option value="{{ c.id }}">{{ c.nom_client }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label fw-bold">Vendeur</label>
              <select name="vendeur_id" class="form-select" required>
                <option value="">-- Vendeur --</option>
                {% for v in vendeurs %}
                  <option value="{{ v.id }}">{{ v.nom }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label fw-bold">Compagnie</label>
              <select name="compagnie_id" class="form-select" required>
                <option value="">-- Compagnie --</option>
                {% for c in compagnies %}
                  <option value="{{ c.id }}">{{ c.nom }}</option>
                {% endfor %}
              </select>
            </div>

          </div>

          <!-- LIGNES PRODUITS -->
          <table class="table table-sm table-bordered">
            <thead class="table-light">
              <tr>
                <th>Produit</th>
                <th>Conditionnement</th>
                <th>Lot</th>
                <th width="120">Qt√©</th>
                <th width="150">Prix</th>
                <th width="40"></th>
              </tr>
            </thead>

            <tbody id="lignesVente">
            <tr class="ligne-vente">

              <!-- üîπ PRODUIT -->
              <td>
                <select class="form-select produit-select" required>
                  <option value="">-- Produit --</option>
                  {% for p in produits %}
                    <option value="{{ p.id }}">{{ p.nom_produit }}</option>
                  {% endfor %}
                </select>
              </td>

              <!-- üîπ CONDITIONNEMENT -->
              <td>
                <select class="form-select conditionnement-select" required>
                  <option value="">-- Conditionnement --</option>
                  {% for s in stocks %}
                    <option value="{{ s.type_conditionnement.value }}"
                            data-produit="{{ s.produit_id }}">
                      {{ s.type_conditionnement.value|capitalize }}
                    </option>
                  {% endfor %}
                </select>
              </td>

              <!-- üîπ LOT (SEUL stock_id envoy√©) -->
              <td>
                <select name="stock_id[]" class="form-select stock-select" required>
                  <option value="">-- Lot --</option>
                  {% for s in stocks %}
                    <option value="{{ s.id }}"
                            data-produit="{{ s.produit_id }}"
                            data-conditionnement="{{ s.type_conditionnement.value }}">
                      {{ s.numero_lot }} ({{ s.quantite }})
                    </option>
                  {% endfor %}
                </select>
              </td>

              <td>
                <input type="number" name="quantite[]"
                      class="form-control" min="1" required>
              </td>

              <td>
                <input type="number" name="prix_unitaire[]"
                      class="form-control" min="0" step="0.01" required>
              </td>

              <td class="text-center">
                <button type="button"
                        class="btn btn-danger btn-sm supprimer">‚úñ</button>
              </td>

            </tr>
            </tbody>

          </table>

          <button type="button"
                  class="btn btn-outline-secondary mb-3"
                  id="ajouterLigneVente">
            ‚ûï Ajouter ligne
          </button>

          <div class="d-flex justify-content-end gap-2">
            <button type="submit" class="btn btn-primary">
              Valider
            </button>
            <button type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal">
              Annuler
            </button>
          </div>

        </form>
      </div>

    </div>
  </div>
</div>

<!-- JS inchang√© -->
<script>
function ouvrirEdition(row) {
  const id = row.dataset.id;
  if (id) {
    window.location.href = `/vente/${id}/edit`;
  }
}

document.addEventListener("DOMContentLoaded", () => {

  const tbody = document.getElementById("lignesVente");
  const btnAjouter = document.getElementById("ajouterLigneVente");

  // üîπ Ajouter nouvelle ligne
  btnAjouter.addEventListener("click", () => {
    const ligne = tbody.querySelector(".ligne-vente").cloneNode(true);
    ligne.querySelectorAll("input").forEach(i => i.value = "");
    ligne.querySelectorAll("select").forEach(s => {
      s.selectedIndex = 0;
      s.querySelectorAll("option").forEach(opt => opt.style.display = "block");
    });
    tbody.appendChild(ligne);
  });

  // üîπ Supprimer ligne
  tbody.addEventListener("click", e => {
    if (e.target.classList.contains("supprimer") && tbody.children.length > 1) {
      e.target.closest("tr").remove();
    }
  });

  // üîπ Logique Produit ‚Üí Conditionnement ‚Üí Lot
  document.addEventListener("change", e => {

    const row = e.target.closest("tr");
    if (!row) return;

    const produitSelect = row.querySelector(".produit-select");
    const conditionSelect = row.querySelector(".conditionnement-select");
    const lotSelect = row.querySelector(".stock-select");

    // üîπ 1Ô∏è‚É£ Filtrer conditionnement selon produit
    if (e.target.classList.contains("produit-select")) {

      const produitId = produitSelect.value;

      conditionSelect.value = "";
      lotSelect.value = "";

      conditionSelect.querySelectorAll("option").forEach(opt => {
        if (!opt.dataset.produit) return;
        opt.style.display =
          opt.dataset.produit === produitId ? "block" : "none";
      });

      lotSelect.querySelectorAll("option").forEach(opt => {
        if (!opt.dataset.produit) return;
        opt.style.display = "none";
      });
    }

    // üîπ 2Ô∏è‚É£ Filtrer lot selon produit + conditionnement
    if (e.target.classList.contains("conditionnement-select")) {

      const produitId = produitSelect.value;
      const condition = conditionSelect.value;

      lotSelect.value = "";

      lotSelect.querySelectorAll("option").forEach(opt => {

        if (!opt.dataset.produit) return;

        const matchProduit = opt.dataset.produit === produitId;
        const matchCondition = opt.dataset.conditionnement === condition;

        opt.style.display =
          matchProduit && matchCondition ? "block" : "none";
      });
    }

  });

});
</script>

{% endblock %}
