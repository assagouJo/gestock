{% extends "base.html" %}
{% block title %}Ã‰tat du Stock | gestock{% endblock %}

{% block content %}
<div class="py-3">

  <!-- HEADER -->
  <div class="col-6 d-flex justify-content-between align-items-center">
    <h4>Ã‰tat du Stock</h4>
    <button class="btn btn-outline-success"
            data-bs-toggle="modal"
            data-bs-target="#addAchatModal">
      âž• EntrÃ©e Stock
    </button>
  </div>

  <hr>

  <!-- TABLE STOCK -->
  {% if stocks %}
  <form action="{{ url_for('delete_lot') }}" method="post">
    <div class="table-responsive" style="max-height: 330px; overflow-y: auto;">
      <table class="table w-100 caption-top table-bordered px-1 align-middle table-responsive my-2">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>Code Produit</th>
            <th>Magasin</th>
            <th>Produit</th>
            <th>Conditionnement</th>
            <th>QuantitÃ©</th>
            <th>Statut</th>
          </tr>
        </thead>

        <tbody>
        {% for s in stocks %}
          <tr class="stock-row"
              data-id="{{ s.id }}"
              data-magasin="{{ s.magasin.id }}"
              data-produit="{{ s.produit.id }}"
              data-quantite="{{ s.quantite }}"
              data-conditionnement="{{ s.type_conditionnement.value }}"
              style="cursor:pointer">

            <td class="text-center align-middle">
              <input type="checkbox"
                     name="stock_ids[]"
                     value="{{ s.id }}">
            </td>

            <td>{{ s.produit.code_produit }}</td>
            <td>{{ s.magasin.nom }}</td>
            <td>{{ s.produit.nom_produit }}</td>
            <td>{{ s.type_conditionnement.value }}</td>
            <td class="fw-bold">{{ s.quantite }}</td>

            <td>
              {% if s.quantite == 0 %}
                <span class="badge bg-danger">Rupture</span>
              {% elif s.quantite < s.seuil_alerte %}
                <span class="badge bg-warning text-dark">Faible</span>
              {% else %}
                <span class="badge bg-success">Disponible</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <button type="submit"
            class="btn btn-outline-danger mt-2"
            onclick="return confirm('Supprimer les Ã©lÃ©ments sÃ©lectionnÃ©s ?')">
      ðŸ—‘ Supprimer
    </button>
  </form>
  {% else %}
    <div class="alert alert-warning text-center mt-3">
      Aucun produit en stock pour le moment.
    </div>
  {% endif %}

  <!-- ================= MODAL ================= -->
  <div class="modal fade" id="addAchatModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Nouvelle EntrÃ©e de Stock</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <form method="post"
                id="stockForm"
                action="{{ url_for('ajouter_stock') }}">

           <div class="table-responsive">
            <table class="table table-bordered align-middle shadow-sm">
              
              <thead class="table-dark text-center">
                <tr>
                  <th>Code Produit</th>
                  <th>Magasin</th>
                  <th>Produit</th>
                  <th>Conditionnement</th>
                  <th>QuantitÃ©</th>
                  <th></th>
                </tr>
              </thead>

              <tbody id="lignesStock">
                <tr class="ligne-stock">

                  <!-- CODE PRODUIT (auto affichÃ©) -->
                  <td>
                    <input type="text"
                           class="form-control form-control-sm code-produit"
                           placeholder="Code auto"
                           readonly>
                  </td>

                  <!-- MAGASIN -->
                  <td>
                    <select name="magasin_id[]"
                            class="form-select form-select-sm mb-2">
                      <option value="">--- Choisir ---</option>
                      {% for magasin in magasins %}
                        <option value="{{ magasin.id }}">
                          {{ magasin.nom }}
                        </option>
                      {% endfor %}
                    </select>

                    <input type="text"
                           name="nouveau_magasin[]"
                           class="form-control form-control-sm"
                           placeholder="Nouveau magasin (optionnel)">
                  </td>

                  <!-- PRODUIT -->
                  <td>
                    <select name="produit_id[]"
                            class="form-select form-select-sm produit-select"
                            required>
                      <option value="">-- Choisir un produit --</option>
                      {% for p in produits_all %}
                        <option value="{{ p.id }}"
                                data-code="{{ p.code_produit }}">
                          {{ p.nom_produit }}
                        </option>
                      {% endfor %}
                    </select>
                  </td>

                  <!-- CONDITIONNEMENT -->
                  <td>
                    <select name="type_conditionnement[]"
                            class="form-select form-select-sm"
                            required>
                      <option value="">-- Choisir --</option>
                      <option value="carton">ðŸ“¦ Carton</option>
                      <option value="paquet">ðŸ“¦ Paquet</option>
                      <option value="unite">ðŸ§¾ UnitÃ©</option>
                    </select>
                  </td>

                  <!-- QUANTITE -->
                  <td>
                    <input type="number"
                           name="quantite[]"
                           class="form-control form-control-sm text-center"
                           min="1"
                           required>
                  </td>

                  <td class="text-center">
                    <button type="button"
                            class="btn btn-outline-danger btn-sm supprimer">
                      x
                    </button>
                  </td>

                </tr>
              </tbody>

            </table>
          </div>

          <div class="d-flex justify-content-end mt-2">
            <button type="button"
                    class="btn btn-outline-primary btn-sm"
                    id="ajouterLigne">
              âž• Ajouter une ligne
            </button>
          </div>
          
          <div class="d-flex justify-content-end gap-2 mt-3">
            <button type="submit" class="btn btn-primary">
              Enregistrer
            </button>
            <button type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal">
              Annuler
            </button>
          </div>

          </form>
        </div>

      </div>
    </div>
  </div>

</div>

<!-- ================= JS ================= -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  const tbody = document.getElementById("lignesStock");
  const btnAjouter = document.getElementById("ajouterLigne");
  const modalEl = document.getElementById("addAchatModal");
  const modal = new bootstrap.Modal(modalEl);
  const form = document.getElementById("stockForm");
  const title = modalEl.querySelector(".modal-title");

  /* ================= AJOUT LIGNE ================= */
  btnAjouter.addEventListener("click", () => {
    const ligne = tbody.querySelector(".ligne-stock").cloneNode(true);
    ligne.querySelectorAll("input").forEach(i => i.value = "");
    ligne.querySelectorAll("select").forEach(s => s.selectedIndex = 0);
    tbody.appendChild(ligne);
  });

  /* ================= SUPPRESSION ================= */
  tbody.addEventListener("click", e => {
    if (e.target.classList.contains("supprimer")) {
      if (tbody.children.length > 1) {
        e.target.closest("tr").remove();
      }
    }
  });

  /* ================= AUTO CODE PRODUIT ================= */
  tbody.addEventListener("change", function(e) {
    if (e.target.classList.contains("produit-select")) {

      const select = e.target;
      const selectedOption = select.options[select.selectedIndex];
      const code = selectedOption.getAttribute("data-code");

      const row = select.closest("tr");
      const inputCode = row.querySelector(".code-produit");

      inputCode.value = code || "";
    }
  });

  /* ================= DOUBLE CLIC MODIFICATION ================= */
  /* ================= DOUBLE CLIC MODIFICATION ================= */
document.querySelectorAll(".stock-row").forEach(row => {
  row.addEventListener("dblclick", function () {

    title.textContent = "Modifier le stock";
    form.action = `/stock/edit/${this.dataset.id}`;

    // ðŸ”¥ On clone AVANT de vider
    const templateRow = tbody.querySelector(".ligne-stock").cloneNode(true);

    // Ensuite on vide
    tbody.innerHTML = "";

    // Puis on ajoute la ligne clonÃ©e
    tbody.appendChild(templateRow);

    const selectProduit = templateRow.querySelector('[name="produit_id[]"]');
    const selectMagasin = templateRow.querySelector('[name="magasin_id[]"]');
    const selectCond = templateRow.querySelector('[name="type_conditionnement[]"]');
    const inputQuantite = templateRow.querySelector('[name="quantite[]"]');
    const inputCode = templateRow.querySelector(".code-produit");

    // Remplissage
    selectProduit.value = this.dataset.produit;
    selectMagasin.value = this.dataset.magasin;
    selectCond.value = this.dataset.conditionnement;
    inputQuantite.value = this.dataset.quantite;

    // Mise Ã  jour code produit
    const selectedOption = selectProduit.options[selectProduit.selectedIndex];
    inputCode.value = selectedOption.getAttribute("data-code") || "";

    btnAjouter.style.display = "none";

    modal.show();
  });
});


  /* ================= RESET MODAL ================= */
  modalEl.addEventListener("hidden.bs.modal", function () {
    title.textContent = "Nouvelle EntrÃ©e de Stock";
    form.action = "{{ url_for('ajouter_stock') }}";
    form.reset();
    btnAjouter.style.display = "inline-block";
  });

});
</script>


{% endblock %}
