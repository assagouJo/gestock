{% extends "base.html" %}
{% block title %}Ã‰tat du Stock | gestock{% endblock %}

{% block content %}
<div class="py-3">

  <!-- HEADER -->
  <div class="col-6 d-flex justify-content-between align-items-center">
    <h4>Ã‰tat du Stock</h4>
    <button class="btn btn-outline-success"
            data-bs-toggle="modal"
            data-bs-target="#addAchatModal">
      âž• EntrÃ©e Stock
    </button>
    <a href="{{ url_for('nouvelle_proforma') }}"
       class="btn btn-primary">
      âž• Nouvelle proforma
    </a>
  </div>

  <hr>

  <!-- TABLE STOCK -->
  {% if stocks %}
  <form action="{{ url_for('delete_lot') }}" method="post">
    <div class="table-responsive" style="max-height: 350px;">
      <table class="table table-bordered table-hover mt-3">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>NumÃ©ro de lot</th>
            <th>Magasin</th>
            <th>Produit</th>
            <th>Conditionnement</th>
            <th>QuantitÃ©</th>
            <th>Statut</th>
          </tr>
        </thead>

        <tbody>
        {% for s in stocks %}
          <tr class="stock-row"
              data-id="{{ s.id }}"
              data-lot="{{ s.numero_lot }}"
              data-magasin="{{ s.magasin.id }}"
              data-produit="{{ s.produit.id }}"
              data-quantite="{{ s.quantite }}"
              data-conditionnement="{{ s.type_conditionnement.value}}"
              style="cursor:pointer">

            <td class="text-center align-middle">
              <input type="checkbox"
                     name="stock_ids[]"
                     value="{{ s.id }}">
            </td>

            <td>{{ s.numero_lot }}</td>
            <td>{{ s.magasin.nom }}</td>
            <td>{{ s.produit.nom_produit }}</td>
            <td>{{s.type_conditionnement.value}}</td>
            <td class="fw-bold">{{ s.quantite }}</td>

            <td>
              {% if s.quantite == 0 %}
                <span class="badge bg-danger">Rupture</span>
              {% elif s.quantite < s.seuil_alerte %}
                <span class="badge bg-warning text-dark">Faible</span>
              {% else %}
                <span class="badge bg-success">Disponible</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <button type="submit"
            class="btn btn-outline-danger mt-2"
            onclick="return confirm('Supprimer les lots sÃ©lectionnÃ©s ?')">
      ðŸ—‘ Supprimer lots
    </button>
  </form>
  {% else %}
    <div class="alert alert-warning text-center mt-3">
      Aucun produit en stock pour le moment.
    </div>
  {% endif %}

  <!-- ================= MODAL ================= -->
  <div class="modal fade" id="addAchatModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Nouvelle EntrÃ©e de Stock</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <form method="post"
                id="stockForm"
                action="{{ url_for('ajouter_stock') }}">

           <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle shadow-sm">
              
              <thead class="table-dark text-center">
                <tr>
                  <th style="width: 140px;">NÂ° Lot</th>
                  <th style="width: 220px;">Magasin</th>
                  <th style="width: 200px;">Produit</th>
                  <th style="width: 150px;">Conditionnement</th>
                  <th style="width: 120px;">QuantitÃ©</th>
                  <th style="width: 50px;"></th>
                </tr>
              </thead>

              <tbody id="lignesStock">
                <tr class="ligne-stock">

                  <!-- ðŸ”¹ LOT -->
                  <td>
                    <input type="text"
                          name="numero_lot[]"
                          class="form-control form-control-sm"
                          placeholder="Ex: LOT-001"
                          required>
                  </td>

                  <!-- ðŸ”¹ MAGASIN -->
                  <td>
                    <select name="magasin_id[]"
                            class="form-select form-select-sm mb-2">
                      <option value="">--- Choisir ---</option>
                      {% for magasin in magasins %}
                        <option value="{{ magasin.id }}">
                          {{ magasin.nom }}
                        </option>
                      {% endfor %}
                    </select>

                    <input type="text"
                          name="nouveau_magasin[]"
                          class="form-control form-control-sm"
                          placeholder="Nouveau magasin (optionnel)">
                  </td>

                  <!-- ðŸ”¹ PRODUIT -->
                  <td>
                    <select name="produit_id[]"
                            class="form-select form-select-sm"
                            required>
                      <option value="">-- Choisir un produit --</option>
                      {% for p in produits_all %}
                        <option value="{{ p.id }}">
                          {{ p.nom_produit }}
                        </option>
                      {% endfor %}
                    </select>
                  </td>

                  <!-- ðŸ”¹ CONDITIONNEMENT -->
                  <td>
                    <select name="type_conditionnement[]"
                            class="form-select form-select-sm"
                            required>
                      <option value="">-- Choisir --</option>
                      <option value="carton">ðŸ“¦ Carton</option>
                      <option value="paquet">ðŸ“¦ Paquet</option>
                      <option value="unite">ðŸ§¾ UnitÃ©</option>
                    </select>
                  </td>

                  <!-- ðŸ”¹ QUANTITÃ‰ -->
                  <td>
                    <input type="number"
                          name="quantite[]"
                          class="form-control form-control-sm text-center"
                          min="1"
                          required>
                  </td>

                  <!-- ðŸ”¹ ACTION -->
                  <td class="text-center">
                    <button type="button"
                            class="btn btn-outline-danger btn-sm supprimer">
                      x
                    </button>
                  </td>

                </tr>
              </tbody>

            </table>
          </div>

          <!-- Bouton ajouter ligne -->
          <div class="d-flex justify-content-end mt-2">
            <button type="button"
                    class="btn btn-outline-primary btn-sm mb-3"
                    id="ajouterLigne">
              âž• Ajouter une ligne
            </button>
          </div>
          
            <div class="d-flex justify-content-end gap-2">
              <button type="submit" class="btn btn-primary">
                Enregistrer
              </button>
              <button type="button"
                      class="btn btn-secondary"
                      data-bs-dismiss="modal">
                Annuler
              </button>
            </div>

          </form>
        </div>

      </div>
    </div>
  </div>

</div>

<!-- ================= JS ================= -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  const tbody = document.getElementById("lignesStock");
  const btnAjouter = document.getElementById("ajouterLigne");
  const modalEl = document.getElementById("addAchatModal");
  const modal = new bootstrap.Modal(modalEl);
  const form = document.getElementById("stockForm");
  const title = modalEl.querySelector(".modal-title");

  // AJOUT LIGNE
  btnAjouter.addEventListener("click", () => {
    const ligne = tbody.querySelector(".ligne-stock").cloneNode(true);
    ligne.querySelectorAll("input").forEach(i => i.value = "");
    ligne.querySelectorAll("select").forEach(s => s.selectedIndex = 0);
    tbody.appendChild(ligne);
  });

  tbody.addEventListener("click", e => {
    if (e.target.classList.contains("supprimer")) {
      if (tbody.children.length > 1) {
        e.target.closest("tr").remove();
      }
    }
  });

  // MODIFICATION DOUBLE-CLIC
  document.querySelectorAll(".stock-row").forEach(row => {
    row.addEventListener("dblclick", function () {

      title.textContent = "Modifier le stock";
      form.action = `/stock/edit/${this.dataset.id}`;

      form.numero_lot.value = this.dataset.lot;
      form.magasin_id.value = this.dataset.magasin;
      form.produit_id.value = this.dataset.produit;
      form.quantite.value = this.dataset.quantite;
      form.type_conditionnement.value = this.dataset.conditionnement

      console.log(this.dataset);
      console.log(this.dataset.conditionnement);

      btnAjouter.style.display = "none";

      modal.show();
    });
  });

  // RESET
  modalEl.addEventListener("hidden.bs.modal", function () {
    title.textContent = "Nouvelle EntrÃ©e de Stock";
    form.action = "{{ url_for('ajouter_stock') }}";
    form.reset();
    btnAjouter.style.display = "inline-block";
  });

});
</script>

{% endblock %}
